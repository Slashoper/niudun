#!/usr/bin/env python
# -*- condig: utf8 -*-
# at time: 2015-06-09
# author : wugq@fastweb.com.cn
#

import commands
import sys
import time
import re
pat = re.compile("\d+\s\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$")


ip_white_list = ['61.174.9.88',
                 '61.174.9.87',
                 '61.174.9.86',
                 '61.174.9.85',
                 '61.163.30.154',
                 '61.163.30.151',
                 '61.163.30.150',
                 '61.163.30.149',
                 '60.8.151.143',
                 '60.8.151.142',
                 '60.8.151.139',
                 '60.8.151.138',
                 '60.12.166.62',
                 '60.12.166.58',
                 '42.236.6.39',
                 '42.236.6.38',
                 '42.236.6.30',
                 '42.236.6.29',
                 '223.94.95.126',
                 '223.94.95.122',
                 '223.94.95.116',
                 '223.94.95.115',
                 '223.94.66.152',
                 '223.94.66.151',
                 '223.94.66.150',
                 '223.94.66.149',
                 '222.88.94.154',
                 '222.88.94.151',
                 '222.88.94.150',
                 '222.88.94.149',
                 '222.186.19.140',
                 '222.186.19.139',
                 '222.186.19.138',
                 '222.186.19.137',
                 '221.204.202.150',
                 '221.204.202.149',
                 '221.204.202.144',
                 '221.204.202.143',
                 '192.168.210.77',
                 '192.168.210.66',
                 '192.168.210.15',
                 '192.168.210.14',
                 '183.56.172.67',
                 '183.56.172.66',
                 '183.56.172.53',
                 '183.56.172.52',
                 '183.250.179.176',
                 '183.250.179.175',
                 '183.250.179.131',
                 '183.250.179.130',
                 '183.232.66.89',
                 '183.232.66.88',
                 '183.232.66.42',
                 '183.232.66.4',
                 '125.39.5.46',
                 '125.39.5.45',
                 '125.39.5.12',
                 '125.39.5.11',
                 '124.193.166.156',
                 '124.193.166.143',
                 '124.193.166.140',
                 '124.193.166.130',
                 '123.149.54.55',
                 '123.149.54.54',
                 '123.149.54.15',
                 '123.149.54.14',
                 '122.70.134.43',
                 '122.70.134.42',
                 '122.70.134.16',
                 '122.70.134.15',
                 '122.226.182.74',
                 '122.226.182.73',
                 '122.226.182.43',
                 '122.226.182.42',
                 '120.92.248.88',
                 '120.92.248.87',
                 '120.92.248.86',
                 '120.92.248.85',
                 '119.97.146.58',
                 '119.97.146.57',
                 '119.97.146.55',
                 '119.97.146.54',
                 '115.231.91.126',
                 '115.231.91.122',
                 '113.31.87.232',
                 '113.31.87.231',
                 '113.31.87.230',
                 '113.31.87.227',
                 '113.31.27.253',
                 '113.31.27.231',
                 '113.31.27.221',
                 '113.31.27.220',
                 '112.253.12.40',
                 '112.253.12.39',
                 '112.253.12.28',
                 '112.253.12.27',
                 '112.25.11.155',
                 '112.25.11.154',
                 '112.25.11.153',
                 '112.25.11.152',
                 '112.121.88.75',
                 '112.121.88.74',
                 '112.121.88.70',
                 '112.121.88.69',
                 '61.174.9.88',
                 '61.174.9.87',
                 '61.174.9.86',
                 '61.174.9.85',
                 '61.163.30.154',
                 '61.163.30.151',
                 '61.163.30.150',
                 '61.163.30.149',
                 '60.8.151.143',
                 '60.8.151.142',
                 '60.8.151.139',
                 '60.8.151.138',
                 '60.12.166.62',
                 '60.12.166.58',
                 '42.236.6.39',
                 '42.236.6.38',
                 '42.236.6.30',
                 '42.236.6.29',
                 '223.94.95.126',
                 '223.94.95.122',
                 '223.94.95.116',
                 '223.94.95.115',
                 '223.94.66.152',
                 '223.94.66.151',
                 '223.94.66.150',
                 '223.94.66.149',
                 '222.88.94.154',
                 '222.88.94.151',
                 '222.88.94.150',
                 '222.88.94.149',
                 '222.186.19.140',
                 '222.186.19.139',
                 '222.186.19.138',
                 '222.186.19.137',
                 '221.204.202.150',
                 '221.204.202.149',
                 '221.204.202.144',
                 '221.204.202.143',
                 '192.168.210.77',
                 '192.168.210.66',
                 '192.168.210.15',
                 '192.168.210.14',
                 '183.56.172.67',
                 '183.56.172.66',
                 '183.56.172.53',
                 '183.56.172.52',
                 '183.250.179.176',
                 '183.250.179.175',
                 '183.250.179.131',
                 '183.250.179.130',
                 '183.232.66.89',
                 '183.232.66.88',
                 '183.232.66.42',
                 '183.232.66.4',
                 '125.39.5.46',
                 '125.39.5.45',
                 '125.39.5.12',
                 '125.39.5.11',
                 '124.193.166.156',
                 '124.193.166.143',
                 '124.193.166.140',
                 '124.193.166.130',
                 '123.149.54.55',
                 '123.149.54.54',
                 '123.149.54.15',
                 '123.149.54.14',
                 '122.70.134.43',
                 '122.70.134.42',
                 '122.70.134.16',
                 '122.70.134.15',
                 '122.226.182.74',
                 '122.226.182.73',
                 '122.226.182.43',
                 '122.226.182.42',
                 '120.92.248.88',
                 '120.92.248.87',
                 '120.92.248.86',
                 '120.92.248.85',
                 '119.97.146.58',
                 '119.97.146.57',
                 '119.97.146.55',
                 '119.97.146.54',
                 '115.231.91.126',
                 '115.231.91.122',
                 '113.31.87.232',
                 '113.31.87.231',
                 '113.31.87.230',
                 '113.31.87.227',
                 '113.31.27.253',
                 '113.31.27.231',
                 '113.31.27.221',
                 '113.31.27.220',
                 '112.253.12.40',
                 '112.253.12.39',
                 '112.253.12.28',
                 '112.253.12.27',
                 '112.25.11.155',
                 '112.25.11.154',
                 '112.25.11.153',
                 '112.25.11.152',
                 '112.121.88.75',
                 '112.121.88.74',
                 '112.121.88.70',
                 '61.174.9.66',
                 '61.174.9.67',
                 '61.174.14.200',
                 '127.0.0.1',
                 '125.39.226.197',
                 '119.97.146.3',
                 '61.156.157.136',
                 '60.55.32.169',
                 '125.39.226.226',
                 '119.97.146.52',
                 '61.156.157.172',
                 '60.55.32.145',
                 '112.121.88.69']

def get_ip():
    try :
        clean_ip()
        #cmd = "ss -anut | awk '{print $6}' | awk -F':' '{print $1}' | sort | uniq -c |sort -rnbk 1 | awk '{if($1>1999)print $1, $2}' | awk '{print $1, $2}'"
        ##### pwaf ####
        #cmd = "ss -anut | awk '{print $6}' | awk -F':' '{print $1}' | sort | uniq -c |sort -rnbk 1 | awk '{if($1>5000)print $1, $2}' | awk '{print $1, $2}'"
        ##### waf #####
        cmd = "/usr/sbin/ss -anut | /bin/awk '{print $6}' | /bin/awk -F':' '{print $1}' | /bin/sort | /usr/bin/uniq -c | /bin/sort -rnbk 1 | /bin/awk '{if($1>2000)print $1, $2}' | /bin/awk '{print $1, $2}' | /bin/grep -v -E '127.0.0.1|0.0.0.0|\*|192.168|ss'"
        ret = commands.getoutput(cmd).split('\n')
        deny_log = open('/var/log/ipdeny.log', 'a')
        clean_denyip = open('/var/log/ipdeny.sh', 'w+')
        clean_denyip.write('#!/bin/sh\n')
        for i in ret:
            if re.findall(pat, i) :
                res = i.split(' ')
                if res[1] in ip_white_list:
                    pass
                else:
                    deny_cmd = 'ip route add blackhole %s' % res[1].strip() 
                    #allow_cmd = 'ip route del blackhole %s/32' % res[1].strip() 
                    commands.getoutput(deny_cmd)
                    deny_log.write('%s\t%s\t%s\n'%(time.strftime('%Y-%m-%d %H:%M:%S'), deny_cmd, res[0]))
                    clean_denyip.write('ip route del blackhole %s\n' % res[1].strip())
            else:
                other_log.write('%s\t%s\n' % (time.strftime('%Y-%m-%d %H:%M:%S'), i))
        deny_log.close()
        clean_denyip.close()
    except Exception, e:
        print 'error: %s' % e


def clean_ip():
    try :
        cmd1 = 'chmod +x /var/log/ipdeny.sh'
        cmd2 = '/bin/bash /var/log/ipdeny.sh'
        commands.getoutput(cmd1)
        commands.getoutput(cmd2)
    except Exception, e:
        print 'error: %s' % e


if __name__ == "__main__":
    get_ip()  
